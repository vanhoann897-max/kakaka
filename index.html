<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Usagi ƒÉn c·∫£ nh√† m√†y!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&display=swap');
        
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            margin: 0; overflow: hidden; 
            background: #fdfcf0; 
            font-family: 'Varela Round', sans-serif; 
            touch-action: none; 
        }

        #game-container { 
            position: relative; width: 100vw; height: 100vh; 
            background: linear-gradient(to bottom, #e0f7fa, #fff9c4); 
            cursor: none; 
        }

        #ui-layer { 
            position: absolute; top: 20px; left: 20px; 
            z-index: 10; pointer-events: none; 
        }

        .info-box { 
            background: rgba(255,255,255,0.9); 
            padding: 10px 20px; border-radius: 15px; 
            border: 3px solid #ff8fa3; 
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1); 
            margin-bottom: 10px;
            display: inline-block;
        }

        /* Thanh m√°u */
        #hearts {
            font-size: 24px; letter-spacing: 5px;
        }

        #overlay { 
            position: absolute; inset: 0; 
            background: rgba(255,255,255,0.9); 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            z-index: 100; cursor: default; 
        }

        .menu-content { 
            background: white; padding: 30px; 
            border-radius: 40px; border: 5px solid #ff8fa3; 
            text-align: center; box-shadow: 0 10px 0 #ff5c7c; 
            width: 85%; max-width: 400px;
        }

        .play-button { 
            background: #ff8fa3; color: white; border: none; 
            padding: 15px 50px; font-size: 24px; border-radius: 50px; 
            cursor: pointer; font-family: inherit; font-weight: bold; 
            box-shadow: 0 5px 0 #ff5c7c; margin-top: 15px;
        }
        .play-button:active { transform: translateY(3px); box-shadow: 0 2px 0 #ff5c7c; }

        .hidden { display: none !important; }
        #error-msg { position: absolute; bottom: 10px; left: 10px; color: red; font-size: 12px; display: none; }
        
        #mute-btn {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            background: rgba(255,255,255,0.6); padding: 8px; border-radius: 50%;
            cursor: pointer; font-size: 20px; border: 2px solid #ff8fa3;
        }
        
        /* Hi·ªáu ·ª©ng rung m√†n h√¨nh khi m·∫•t m√°u */
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-10px)} 60%{transform:translateX(10px)} }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="mute-btn">üîä</div>

    <div id="ui-layer">
        <div class="info-box">
            <div style="font-size: 20px; color: #ff6b6b;">ƒêi·ªÉm: <span id="score">0</span></div>
            <div style="font-size: 14px; color: #888;">K·ª∑ l·ª•c: <span id="high-score">0</span></div>
        </div>
        <br>
        <div class="info-box">
            <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>
    </div>

    <div id="overlay">
        <div class="menu-content">
            <img src="usagi1.png" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid #ff8fa3; margin-bottom: 10px;">
            <h1 style="color: #ff8fa3; font-size: 24px; margin: 10px 0;">Usagi ƒÉn c·∫£ nh√† m√†y</h1>
            <p style="color: #666; font-size: 14px;">
                ƒë·ª´ng ƒë·ªÉ usagi ƒë·∫øn ƒë∆∞·ª£c nh√† m√†y<br>
                
            </p>
            <button class="play-button" id="start-btn">CH∆†I NGAY</button>
        </div>
    </div>
    <div id="error-msg"></div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // --- T·∫¢I T√ÄI NGUY√äN ---
    const imgNormal = new Image(); imgNormal.src = 'usagi1.png';
    const imgEating = new Image(); imgEating.src = 'usagi.jpg';
    
    const bgMusic = new Audio('chiikawa.mp3');
    bgMusic.loop = true; bgMusic.volume = 0.4;

    const sound1 = new Audio('una.mp3');
    const sound2 = new Audio('una1.mp3');

    // T·∫£i tr∆∞·ªõc (Preload)
    [bgMusic, sound1, sound2].forEach(s => s.load());

    const showError = (msg) => {
        const el = document.getElementById('error-msg');
        el.style.display = 'block';
        el.innerText = "Thi·∫øu file: " + msg;
    };
    imgNormal.onerror = () => showError('usagi1.png');
    imgEating.onerror = () => showError('usagi.jpg');
    bgMusic.onerror = () => showError('chiikawa.mp3');

    let width, height, score = 0, lives = 3, gameActive = false;
    let items = [], frame = 0, speed = 4;
    let isEatingTimer = 0; 
    let isMuted = false;

    // K√≠ch th∆∞·ªõc ng∆∞·ªùi ch∆°i
    const baseSize = window.innerWidth < 600 ? 70 : 90;
    const player = { x: 0, y: 0, size: baseSize, targetX: 0 };

    function resize() {
        width = window.innerWidth; height = window.innerHeight;
        canvas.width = width; canvas.height = height;
        player.y = height - (window.innerWidth < 600 ? 100 : 130);
        player.x = width / 2;
        player.targetX = width / 2;
    }
    window.addEventListener('resize', resize);
    resize();

    // --- ƒêI·ªÄU KHI·ªÇN ---
    window.addEventListener('mousemove', (e) => { if(gameActive) player.targetX = e.clientX; });
    const handleTouch = (e) => {
        if (!gameActive) return;
        e.preventDefault();
        player.targetX = e.touches[0].clientX;
    };
    canvas.addEventListener('touchstart', handleTouch, {passive: false});
    canvas.addEventListener('touchmove', handleTouch, {passive: false});

    // --- LOGIC GAME ---
    function updateHearts() {
        let h = '';
        for(let i=0; i<lives; i++) h += '‚ù§Ô∏è';
        for(let i=lives; i<3; i++) h += 'üñ§'; // Tim ƒëen khi m·∫•t m√°u
        document.getElementById('hearts').innerHTML = h;
    }

    function gameOver() {
        gameActive = false;
        bgMusic.pause(); bgMusic.currentTime = 0;
        document.getElementById('overlay').classList.remove('hidden');
        document.body.style.cursor = 'default';
        
        // C·∫≠p nh·∫≠t text trong Menu
        const reason = lives <= 0 ? "B·ªè ph√≠ ƒë·ªì ƒÉn nhi·ªÅu qu√°!dumaüò≠" : "B·ªã qu√°i v·∫≠t b·∫Øt cmnr üë∫";
        document.querySelector('.menu-content h1').innerText = "GAME OVER";
        document.querySelector('.menu-content p').innerText = reason;

        const oldHigh = localStorage.getItem('usagi_score') || 0;
        if(score > oldHigh) {
            localStorage.setItem('usagi_score', score);
            document.getElementById('high-score').innerText = score;
        }
    }

    document.getElementById('start-btn').onclick = () => {
        document.getElementById('overlay').classList.add('hidden');
        document.body.style.cursor = 'none';
        
        // Reset Game
        score = 0; items = []; speed = 5; frame = 0; lives = 3;
        document.getElementById('score').innerText = '0';
        updateHearts();
        
        gameActive = true;
        if(!isMuted) bgMusic.play().catch(()=>{});
        update();
    };

    document.getElementById('mute-btn').onclick = function() {
        isMuted = !isMuted;
        this.innerText = isMuted ? 'üîá' : 'üîä';
        if(isMuted) bgMusic.pause();
        else if(gameActive) bgMusic.play();
    };

    function playRandomSound() {
        if(isMuted) return;
        const s = (Math.random() > 0.5 ? sound1 : sound2).cloneNode();
        s.volume = 0.8; s.play().catch(()=>{});
    }

    function spawn() {
        const r = Math.random();
        let item = { x: Math.random() * (width - 50) + 25, y: -60, rot: 0, size: 50 };
        
        if (r > 0.25) { // 75% l√† ƒë·ªì ƒÉn
            const foods = ['üç∞', 'ü•ê', 'üçó', 'üçï', 'üå≠', 'üç£','ü•ö','üçñ'];
            item.e = foods[Math.floor(Math.random() * foods.length)];
            item.type = 'good'; 
        } else { // 25% l√† qu√°i v·∫≠t
            item.e = 'üë∫'; 
            item.type = 'bad'; 
            item.size = 60; 
        }
        items.push(item);
    }

    function update() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, width, height);
        frame++;

        player.x += (player.targetX - player.x) * 0.15;

        // V·∫Ω Usagi
        const currentImg = (isEatingTimer > 0) ? imgEating : imgNormal;
        if (isEatingTimer > 0) isEatingTimer--;
        ctx.drawImage(currentImg, player.x - player.size/2, player.y - player.size/2, player.size, player.size);

        // TƒÉng t·ªëc ƒë·ªô r∆°i theo ƒëi·ªÉm
        if (frame % Math.max(15, 45 - Math.floor(score/5)) === 0) spawn();

        for (let i = items.length - 1; i >= 0; i--) {
            let o = items[i];
            o.y += speed + (score/25);
            o.rot += 0.03;
            
            ctx.save();
            ctx.translate(o.x, o.y); ctx.rotate(o.rot);
            ctx.font = o.size + 'px Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(o.e, 0, 0);
            ctx.restore();

            const hitDist = window.innerWidth < 600 ? 50 : 60; 
            
            // 1. X·ª≠ l√Ω va ch·∫°m
            if (Math.hypot(player.x - o.x, player.y - o.y) < hitDist) {
                if (o.type === 'bad') {
                    gameOver(); // Ch·∫°m qu√°i v·∫≠t = Ch·∫øt lu√¥n
                    return;
                } else {
                    score += 1;
                    document.getElementById('score').innerText = score;
                    playRandomSound(); 
                    isEatingTimer = 20; 
                    items.splice(i, 1);
                }
            } 
            // 2. X·ª≠ l√Ω khi r∆°i ra ngo√†i m√†n h√¨nh
            else if (o.y > height + 50) {
                if (o.type === 'good') {
                    // M·∫•t m√°u n·∫øu ƒë·ªì ƒÉn r∆°i
                    lives--;
                    updateHearts();
                    document.getElementById('game-container').classList.add('shake'); // Rung m√†n h√¨nh
                    setTimeout(()=>document.getElementById('game-container').classList.remove('shake'), 400);

                    if (lives <= 0) {
                        gameOver();
                        return;
                    }
                }
                items.splice(i, 1);
            }
        }
        requestAnimationFrame(update);
    }
    document.getElementById('high-score').innerText = localStorage.getItem('usagi_score') || 0;
</script>
</body>
</html>
